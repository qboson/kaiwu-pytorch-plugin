/**
 * Jet Clustering Visualization Dashboard - Main JavaScript
 * Handles UI interactions, API calls, and result rendering
 */

// DOM Elements
const nParticlesSlider = document.getElementById('n-particles');
const nJetsSlider = document.getElementById('n-jets');
const nEventsSlider = document.getElementById('n-events');
const algorithmSelect = document.getElementById('algorithm');
const runBtn = document.getElementById('run-btn');
const compareBtn = document.getElementById('compare-btn');
const resultImage = document.getElementById('result-image');
const loadingState = document.getElementById('visualization-loading');
const comparisonSection = document.getElementById('comparison-section');
const comparisonBody = document.getElementById('comparison-body');

// Metric displays
const avgAngleDisplay = document.getElementById('avg-angle');
const angleErrorDisplay = document.getElementById('angle-error');
const efficiencyDisplay = document.getElementById('efficiency');
const currentAlgoDisplay = document.getElementById('current-algo');

// State
let isRunning = false;

// Initialize sliders with value displays
function initSliders() {
    const sliders = [
        { slider: nParticlesSlider, display: 'n-particles-value' },
        { slider: nJetsSlider, display: 'n-jets-value' },
        { slider: nEventsSlider, display: 'n-events-value' }
    ];

    sliders.forEach(({ slider, display }) => {
        const displayEl = document.getElementById(display);
        
        slider.addEventListener('input', () => {
            displayEl.textContent = slider.value;
        });
    });
}

// API Functions
async function runExperiment() {
    if (isRunning) return;
    
    isRunning = true;
    setLoading(true);
    
    const params = {
        n_particles: parseInt(nParticlesSlider.value),
        n_jets: parseInt(nJetsSlider.value),
        n_events: parseInt(nEventsSlider.value),
        algorithm: algorithmSelect.value
    };

    try {
        const response = await fetch('/api/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        });

        const data = await response.json();

        if (data.success) {
            displayResult(data.result);
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError('网络错误: ' + error.message);
    } finally {
        isRunning = false;
        setLoading(false);
    }
}

async function compareAlgorithms() {
    if (isRunning) return;
    
    isRunning = true;
    setLoading(true);
    comparisonSection.classList.remove('hidden');
    
    const params = {
        n_particles: parseInt(nParticlesSlider.value),
        n_jets: parseInt(nJetsSlider.value),
        n_events: parseInt(nEventsSlider.value)
    };

    try {
        const response = await fetch('/api/compare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        });

        const data = await response.json();

        if (data.success) {
            displayComparison(data.results);
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError('网络错误: ' + error.message);
    } finally {
        isRunning = false;
        setLoading(false);
    }
}

// Display Functions
function displayResult(result) {
    // Show image
    if (result.image) {
        resultImage.src = 'data:image/png;base64,' + result.image;
        resultImage.classList.remove('hidden');
        loadingState.classList.add('hidden');
    }

    // Update metrics
    avgAngleDisplay.textContent = result.avg_angle.toFixed(4);
    angleErrorDisplay.textContent = '±' + result.angle_error.toFixed(4);
    efficiencyDisplay.textContent = (result.efficiency * 100).toFixed(1) + '%';
    currentAlgoDisplay.textContent = getAlgorithmDisplayName(result.algorithm);
}

function displayComparison(results) {
    // Clear previous results
    comparisonBody.innerHTML = '';

    const algorithms = ['qaoa', 'kt', 'kmeans'];
    
    algorithms.forEach(algo => {
        const result = results[algo];
        const row = document.createElement('tr');
        
        if (result.error) {
            row.innerHTML = `
                <td>${getAlgorithmDisplayName(algo)}</td>
                <td colspan="3">错误: ${result.error}</td>
                <td><span class="status-error">✗</span></td>
            `;
        } else {
            row.innerHTML = `
                <td>${getAlgorithmDisplayName(algo)}</td>
                <td>${result.avg_angle.toFixed(4)}</td>
                <td>±${result.angle_error.toFixed(4)}</td>
                <td>${(result.efficiency * 100).toFixed(1)}%</td>
                <td><span class="status-success">✓</span></td>
            `;
        }
        
        comparisonBody.appendChild(row);
    });

    // Show the first algorithm's image
    const firstResult = results.qaoa || results.kt || results.kmeans;
    if (firstResult && firstResult.image) {
        resultImage.src = 'data:image/png;base64,' + firstResult.image;
        resultImage.classList.remove('hidden');
        loadingState.classList.add('hidden');
    }
}

function getAlgorithmDisplayName(algo) {
    const names = {
        'qaoa': 'QAOA 量子模拟',
        'kt': 'e⁺e⁻ kt 算法',
        'kmeans': 'k-Means 聚类'
    };
    return names[algo] || algo;
}

function setLoading(loading) {
    runBtn.disabled = loading;
    compareBtn.disabled = loading;
    
    if (loading) {
        runBtn.innerHTML = '<span class="spinner-small"></span> 计算中...';
    } else {
        runBtn.innerHTML = '<span class="btn-icon">▶</span> 运行实验';
    }
}

function showError(message) {
    loadingState.innerHTML = `
        <div style="color: #ef4444;">
            <p>❌ 错误</p>
            <p style="font-size: 0.85rem;">${message}</p>
        </div>
    `;
    loadingState.classList.remove('hidden');
    resultImage.classList.add('hidden');
}

// Animation effects
function addRippleEffect(element) {
    element.addEventListener('click', function(e) {
        const ripple = document.createElement('span');
        ripple.classList.add('ripple');
        
        const rect = element.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = e.clientX - rect.left - size/2 + 'px';
        ripple.style.top = e.clientY - rect.top - size/2 + 'px';
        
        element.appendChild(ripple);
        
        setTimeout(() => ripple.remove(), 600);
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initSliders();
    
    // Event listeners
    runBtn.addEventListener('click', runExperiment);
    compareBtn.addEventListener('click', compareAlgorithms);
    
    // Add button effects
    addRippleEffect(runBtn);
    addRippleEffect(compareBtn);
    
    // Check backend status
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            console.log('Backend status:', data);
        })
        .catch(error => {
            console.warn('Backend not available:', error);
            loadingState.innerHTML = `
                <div style="color: #f59e0b;">
                    <p>⚠ 后端未连接</p>
                    <p style="font-size: 0.85rem;">请运行 python web/app.py 启动服务</p>
                </div>
            `;
        });
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !isRunning) {
        runExperiment();
    }
});

console.log('Jet Clustering Dashboard loaded');
